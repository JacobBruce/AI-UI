<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI UI</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
	<link rel="stylesheet" href="styles.css">
	<script>window.$ = window.jQuery = require('jquery');</script>
	<script>
	const { ipcRenderer } = require('electron');
	
	const pedit_img_html = '<button id="edit_btn" onclick="ToggleEditPrompt()"><img class="edit_img" src="./img/edit_w.png" width="15" /></button>';
	const default_ip = "Chat log between HUMAN_NAME and BOT_NAME on DATE";
	const pygmalion_ip = "BOT_NAME's Persona: A helpful AI assistant who can use the [AI_IMG] tag to generate images from a description.\n<START>\nHUMAN_NAME: show me an image of a cyberpunk cityscape\nBOT_NAME: [AI_IMG]cyberpunk cityscape[/AI_IMG]";
	const bbcode_ip = "Use the [CODE] tag to post a code snippet. Example: [CODE]int abc = 123;[/CODE]\nUse the [AI_IMG] tag to generate an image from a description using AI. Example: [AI_IMG]cute kitten[/AI_IMG]";
	var ip_vals = { chat:'', pygmalion:'', bbcode:'' };
	
	var avatar_vid = null;
	var speech_audio = null;
	var loop_timer = null;
	var dot_count = 0;
	var rnd_int = 0;
	var btn_state = true;
	var thinking = false;
	var generating = false;
	var chat_exp = false;
	var gen_exp = false;
	var adv_show = false;
	var voice_arr = [];
	var think_targ = '';
	var prompt = '';

	var human_name = 'Human';
	var bot_name = 'Bot';
	var bot_voice = 0;
	var speech_vol = 1.0;
	var speech_rate = 200;
	var pitch_shift = 0;
	var talk_mode = 0;

	var max_mm = 5;
	var max_rl = 50;
	var min_rl = 1;;
	var b_temp = 0.8;
	var prompt_p = 0;
	var top_k = 50;
	var top_p = 1.0;
	var typical_p = 1.0;
	var rep_penalty = 1.0;
	
	var model_type = 0;
	var comp_dev = 'auto';
	var start_meth = 'text';
	var script_dir = '';
	var model_args = ''
	var model_dir = '';
	var sd_model = '';
	var python_bin = '';
	var avatar_mp4 = '';
	var avatar_img = '';
	
	function RandInt(max_val=9999999) {
		let rnd = Math.floor(Math.random() * max_val);
		while (rnd_int == rnd)
			rnd = Math.floor(Math.random() * max_val);
		rnd_int = rnd;
		return rnd;
	}
	
	function PlayVideo() {
		if ($('#other_vid').is(":hidden")) {
			$('#other_source').prop('src', avatar_mp4+'?rnd='+RandInt());
			avatar_vid = document.getElementById('other_vid');
		} else {
			$('#avatar_source').prop('src', avatar_mp4+'?rnd='+RandInt());
			avatar_vid = document.getElementById('avatar_vid');
		}
		avatar_vid.oncanplaythrough = function() {
			if ($('#other_vid').is(":hidden")) {
				$('#avatar_vid').hide();
			} else {
				$('#other_vid').hide();
			}
			$(avatar_vid).show();
			avatar_vid.play();
		};
		avatar_vid.load();
	}

	function PlayAudio(audio_file) {
		if (speech_audio !== null && !speech_audio.paused) speech_audio.pause();
		speech_audio = new Audio('file://'+audio_file+'?rnd='+RandInt());
		speech_audio.onended = function() { $('#read_txt_btn').html('TEXT TO SPEECH'); };
		speech_audio.play();
	}
	
	function ToggleAudio() {
		if (speech_audio === null) return;
		if (speech_audio.paused) {
			speech_audio.play();
		} else {
			speech_audio.pause();
		}
	}
	
	function EncodeHTML(txt) {
		return txt.replaceAll('&', '&amp;').
			replaceAll('<', '&lt;').
			replaceAll('>', '&gt;').
			replaceAll('"', '&quot;').
			replaceAll('\'', '&apos;').
			replaceAll('/', '&#47;').
			replaceAll('\\', '&#92;').
			replaceAll('\t', '&nbsp;&nbsp;');
	}
	
	function ConvertAIBB(txt) {
		return txt.replaceAll("[AI_UI_BR]", "<br>").replaceAll("[AI_UI_TAB]", "\t").replaceAll("[AI_UI_LF]", "\n").
			replaceAll("[CODE START]", '</p><pre class="code_box">').replaceAll("[CODE END]", '</pre><p class="msg_p">').
			replaceAll("[AI_IMG NUM_", '</p><img class="chat_img" src="file://'+script_dir+'/ai_images/image_').
			replaceAll("_CHAT_IMG]", '.png" title="').replaceAll("[AI_IMG END]", '" onclick="ShowInFolder(this)"><p class="msg_p">');
	}
	
	function ConvertBB(txt) {
		return txt.replaceAll("[AI_UI_TAB]", "\t").replaceAll("[AI_UI_LF]", "\n").
			replaceAll('[CODE START]', '</p><pre class="code_box">').replaceAll('[CODE END]', '</pre><p class="msg_p">');
	}
	
	function EncodeBB(bbcode) {
		let result = bbcode;
		while (result.includes('[CODE]') && result.includes('[/CODE]')) {
			const tag_start = result.indexOf("[CODE]") + 6;
			const tag_end = result.indexOf("[/CODE]");
			if (tag_start >= tag_end) break;
			const code_txt = result.substring(tag_start, tag_end);
			const code_enc = code_txt.replaceAll("\t", "[AI_UI_TAB]").replaceAll("\n", "[AI_UI_LF]");
			result = result.replace('[CODE]'+code_txt+'[/CODE]', '[CODE START]'+code_enc+'[CODE END]');
		}
		return result;
	}

	function TrimLast(str, chr) {
		if (str.endsWith(chr)) {
			return str.slice(0, -1);
		} else {
			return str;
		}
	}

	// ---- PAGES ----
	
	function HidePages() {
		$('#chat_app').hide();
		$('#txtgen_app').hide();
		$('#imggen_app').hide();
		$('#console_tab').hide();
		$('#config_tab').hide();
		$('#about_tab').hide();
	}
	
	function SelectPage(btn) {
		$('.menu_btn').removeClass('menu_sel');
		btn.classList.add('menu_sel');
		HidePages();
	}
	
	function ChatPage(btn) {
		SelectPage(btn);
		$('#chat_app').show();
	}
	
	function TextPage(btn) {
		SelectPage(btn);
		$('#txtgen_app').show();
	}
	
	function ImagePage(btn) {
		SelectPage(btn);
		$('#imggen_app').show();
	}
	
	function ConfigPage(btn) {
		SelectPage(btn);
		$('#config_tab').show();
	}
	
	function ConsolePage(btn) {
		SelectPage(btn);
		$('#console_tab').show();
	}

	function AboutPage(btn) {
		SelectPage(btn);
		$('#about_tab').show();
	}
	
	// ---- CHAT ----
	
	function ThinkAnim() {
		const targ = (thinking) ? '#thinking' : think_targ;
		switch (dot_count) {
		case 0: 
			$(targ).html('');
			dot_count++;
			break;
		case 1:
			$(targ).html('.');
			dot_count++;
			break;
		case 2:
			$(targ).html('..');
			dot_count++;
			break;
		case 3:
			$(targ).html('...');
			dot_count++;
			break;
		case 4:
			$(targ).html('..');
			dot_count++;
			break;
		case 5:
			$(targ).html('.');
			dot_count = 0;
			break;
		}
	}
	
	function StartThinking() {
		thinking = true;
		let scroll_box = $('#chat_log');
		scroll_box.animate({scrollTop: scroll_box.prop("scrollHeight")}, 300, 'linear', function() {
			$('#thinking').html('');
			$('#thinking').show();
			dot_count = 1;
			loop_timer = setInterval(ThinkAnim, 1000);
		});
	}
	
	function StopThinking() {
		thinking = false;
		let scroll_box = $('#chat_log');
		scroll_box.animate({scrollTop: scroll_box.prop("scrollHeight")});
		$('#thinking').hide();
		clearInterval(loop_timer);
	}
	
	function DisExtraButtons(bool_val) {
		$('#redo_btn').prop('disabled', bool_val);
		$('#cont_btn').prop('disabled', bool_val);
		$('#clear_btn').prop('disabled', bool_val);
	}
	
	function DisableButtons(bool_val, load_state=false) {
		let new_state = bool_val;
		if (load_state) {
			new_state = bool_val ? true : btn_state;
		} else {
			btn_state = bool_val;
		}
		DisExtraButtons(new_state);
		$('#apply_btn').prop('disabled', bool_val);
		$('#gen_btn').prop('disabled', bool_val);
		$('#img_btn').prop('disabled', bool_val);
		$('#edit_btn').prop('disabled', bool_val);
		$('.config_btn').prop('disabled', bool_val);
	}
	
	ipcRenderer.on('bot-msg', (event, payload) => {
		const bot_msg = ConvertAIBB(EncodeHTML(payload.msg.trim()));
		const msg_html = '<div class="bmsg_box"><div class="bot_msg"><p class="msg_p">'+bot_msg+'</p></div></div>';
		$('#chat_log').append(msg_html.replaceAll('<p class="msg_p"></p>', ''));
		$('.msg_pad').remove();
		DisableButtons(false);
		StopThinking();
		if (payload.got_vid && talk_mode == 0) {
			$('#avatar_img').hide();
			PlayVideo();
		}
	});
	
	function SendMsg() {
		if (thinking || generating) return;//TODO: remove this for multi msg from user
		if ($('#send_btn').prop('disabled')) return;
		let message = '';
		let html_msg = '';
		if (chat_exp) {
			message = $('#area_inp').val().trim();
			html_msg = ConvertBB(EncodeHTML(EncodeBB(message)).replaceAll("\n", "<br>"));
			message = message.replaceAll("\n", "[AI_UI_BR]");
			$('#area_inp').val('');
		} else {
			message = $('#text_inp').val().trim();
			html_msg = ConvertBB(EncodeHTML(EncodeBB(message)));
			$('#text_inp').val('');
		}
		if (message == '') return;
		html_msg = '<div class="umsg_box"><div class="chat_msg"><p class="msg_p">'+html_msg+'</p></div></div>';
		$('#chat_log').append(html_msg.replaceAll('<p class="msg_p"></p>', ''));
		$('#edit_dialog').hide();
		ipcRenderer.send('send-msg', { msg: message });
		DisableButtons(true);
		StartThinking();
	}
	
	function RedoLast() {
		$('.bmsg_box').last().remove();
		if ($('#chat_log').children().last().hasClass('bmsg_box'))
			$('#chat_log').append('<div class="msg_pad"></div>');
		DisableButtons(true);
		ipcRenderer.send('send-msg', { msg: 'redo_last' });
		StartThinking();
	}
	
	function ContChat() {
		DisableButtons(true);
		ipcRenderer.send('send-msg', { msg: 'cont_chat' });
		$('#chat_log').append('<div class="msg_pad"></div>');
		StartThinking();
	}
	
	function ClearChat() {
		btn_state = true;
		DisExtraButtons(true);
		$('#chat_log').html('');
		ipcRenderer.send('send-msg', { msg: 'clear_chat' });
	}
	
	function ToggleMsgBox() {
		if (chat_exp) {
			$('#area_inp').hide();
			$('#text_inp').prop('disabled', false);
			$('#text_inp').focus();
		} else {
			$('#area_inp').show();
			$('#text_inp').prop('disabled', true);
			$('#area_inp').focus();
		}
		chat_exp = !chat_exp;
	}
	
	// ---- TEXT GEN ----

	function StartGenerating(targ) {
		generating = true;
		think_targ = targ;
		$(think_targ).html('');
		$(think_targ).show();
		dot_count = 1;
		loop_timer = setInterval(ThinkAnim, 1000);
	}
	
	function StopGenerating(targ='.generating') {
		generating = false;
		$(targ).hide();
		clearInterval(loop_timer);
	}
	
	function ToggleGenBox() {
		if (gen_exp) {
			$('#gen_area_inp').hide();
			$('#gen_text_inp').prop('disabled', false);
			$('#gen_text_inp').focus();
		} else {
			$('#gen_area_inp').show();
			$('#gen_text_inp').prop('disabled', true);
			$('#gen_area_inp').focus();
		}
		gen_exp = !gen_exp;
	}
	
	function CopyGenTxt() {
		const gen_txt = $('#gen_result').html().replaceAll("<br>", "\n");
		ipcRenderer.send('copy-text', { txt: gen_txt });
	}
	
	function ReadGenTxt() {
		if ($('#read_txt_btn').html() == 'TEXT TO SPEECH') {
			if (thinking || generating) {
				ipcRenderer.send('show-alert', { msg: 'The engine is busy with another task.' });
				return;
			}
			const gen_txt = $('#gen_result').html().replaceAll("<br>", "[AI_UI_BR]");
			if (gen_txt != '') $('#read_txt_btn').html('STOP READING');
			ipcRenderer.send('read-text', { txt: gen_txt });
		} else if ($('#read_txt_btn').html() == 'STOP READING') {
			$('#read_txt_btn').html('CONTINUE READING');
			ToggleAudio();
		} else {
			$('#read_txt_btn').html('STOP READING');
			ToggleAudio();
		}
	}
	
	function GenText() {
		if (thinking || generating) return;
		if ($('#gen_btn').prop('disabled')) return;
		let start_txt = '';
		if (gen_exp) {
			start_txt = $('#gen_area_inp').val().replaceAll("\n", "[AI_UI_BR]");
		} else {
			start_txt = $('#gen_text_inp').val();
		}
		if (start_txt == '') return;
		DisableButtons(true, true);
		$('#gen_result').html('Generating text ...');
		const max_genl = $('#gen_max_len').val();
		const min_genl = $('#gen_min_len').val();
		const gen_temp = $('#gen_temp').val();
		const gen_topk = $('#gen_top_k').val();
		const gen_topp = $('#gen_top_p').val();
		const gen_typp = $('#gen_typ_p').val();
		const gen_repp = $('#gen_rep_p').val();
		ipcRenderer.send('gen-text', {
			txt: start_txt, max: max_genl, min: min_genl, temp: gen_temp,
			top_k: gen_topk, top_p: gen_topp, typ_p: gen_typp, rep_p: gen_repp
		});
		StartGenerating('#txtgen_box .generating');
	}
	
	ipcRenderer.on('gen-result', (event, payload) => {
		const txt_html = EncodeHTML(payload.txt).replaceAll("[AI_UI_BR]", "<br>");
		DisableButtons(false, true);
		$('#gen_result').html(txt_html);
		$('#read_txt_btn').html('TEXT TO SPEECH');
		StopGenerating('#txtgen_box .generating');
	});
	
	// ---- IMAGE GEN ----
	
	function CopyGenImg() {
		let gen_img = document.getElementById('gen_img');
		if (gen_img === null) {
			ipcRenderer.send('show-alert', { msg: "There is no image to copy!" });
		} else {
			gen_img = $(gen_img).prop('src').
				replace('file:///', '').replace('file://', '');
			ipcRenderer.send('copy-image', { img: gen_img });
		}
	}
	
	function OpenImgDir() {
		const gen_img = document.getElementById('gen_img');
		ShowInFolder(gen_img);
	}
	
	function GenImage() {
		if (thinking || generating) return;
		if ($('#img_btn').prop('disabled')) return;
		let prompt_txt = $('#img_text_inp').val();
		let prompt_neg = $('#img_text_neg').val();
		if (prompt_txt == '') return;
		if (prompt_neg == '') prompt_neg = 'NONE';
		DisableButtons(true, true);
		$('#img_result').html('Generating image ...');
		const infer_steps = $('#infer_steps').val();
		const guide_scale = $('#guidance').val();
		let img_width = 'auto';
		let img_height = 'auto';
		if ($('#is_select').find(':selected').val() == 'custom') {
			img_width = $('#img_width').val();
			img_height = $('#img_height').val();
		}
		ipcRenderer.send('gen-image', {
			img_prompt: prompt_txt, neg_prompt: prompt_neg, steps: infer_steps, 
			guidance: guide_scale, width: img_width, height: img_height
		});
		StartGenerating('#imggen_box .generating');
	}
	
	ipcRenderer.on('img-result', (event, payload) => {
		const img_html = "<img id='gen_img' src='file://"+script_dir+"/ai_images/image_"+payload.img+".png'>";
		DisableButtons(false, true);
		$('#img_result').html(img_html);
		StopGenerating('#imggen_box .generating');
	});

	// ---- APP ----

	ipcRenderer.on('init-ui', (event, payload) => {
		if (payload.state !== false) {
			const d = new Date();
			const curr_date = (d.getMonth()+1)+'/'+d.getDate()+'/'+d.getFullYear();
			const pyg_ip = pygmalion_ip.replaceAll('HUMAN_NAME', human_name).replaceAll('BOT_NAME', bot_name).replaceAll('DATE', curr_date);
			if (payload.state == 'AI_UI_DEFAULT') {
				prompt = default_ip.replaceAll('HUMAN_NAME', human_name).replaceAll('BOT_NAME', bot_name).replaceAll('DATE', curr_date);
				ip_vals = { chat:prompt, pygmalion:pyg_ip, bbcode:bbcode_ip };
			} else {
				prompt = payload.state;
			}
			$('#prompt_txta').val(prompt);
			$('#ip_select').val('default');
			$('#chat_log').html('<div class="prompt"><p id="init_prompt" class="prompt_txt">'+
				EncodeHTML(prompt)+' '+pedit_img_html+'</p></div>');
			$('#gen_result').html('');
			$('#img_result').html('');
		} else {
			$('#send_btn').prop('disabled', true);
			$('#read_txt_btn').prop('disabled', true);
			DisableButtons(true);
			StopThinking();
			StopGenerating();
		}
	});
	
	ipcRenderer.on('ai-ready', (event, payload) => {
		$('#send_btn').prop('disabled', false);
		$('#read_txt_btn').prop('disabled', false);
		DisableButtons(false, true);
		StopThinking();
		StopGenerating();
	});
	
	ipcRenderer.on('add-voice', (event, payload) => {
		let prop_str = voice_arr.length+'"';
		if (voice_arr.length == bot_voice) {
			prop_str = voice_arr.length+'" selected';
		}
		$('#voices').append('<option value="'+prop_str+'>'+payload.name+'</option>');
		voice_arr.push(payload);
	});
	
	ipcRenderer.on('play-audio', (event, payload) => {
		PlayAudio(payload.file);
	});
	
	ipcRenderer.on('append-log', (event, payload) => {
		$('#log_box').append('<pre class="console_log">'+EncodeHTML(payload.msg)+'</pre>');
	});
	
	ipcRenderer.on('got-avatar', (event, payload) => {
		$('#loading_box').hide();
		if (payload.got != "true")
			ipcRenderer.send('show-alert', { type: "error", msg: "Unable to detect face in image!" });
	});
	
	ipcRenderer.on('prompt-msg', (event, payload) => {
		$('#init_prompt').html(payload.msg);
		$('#gen_result').html(payload.msg);
		$('#img_result').html(payload.msg);
	});
	
	ipcRenderer.on('load-config', (event, payload) => {
		const chat_config = payload.configs.chat;
		const app_config = payload.configs.app;
		const ai_config = payload.configs.ai;
		const gen_config = payload.configs.gen;
		
		human_name = chat_config.human_name;
		bot_name = chat_config.bot_name;
		bot_voice = chat_config.bot_voice;
		speech_vol = chat_config.speech_vol;
		speech_rate = chat_config.speech_rate;
		pitch_shift = chat_config.pitch_shift;
		talk_mode = chat_config.talk_mode;

		avatar_img = app_config.avatar_img;
		script_dir = app_config.script_dir;
		python_bin = app_config.python_bin;
		model_dir = app_config.model_dir;
		sd_model = app_config.sd_model;
		model_args = app_config.model_args;
		model_type = app_config.model_type;
		comp_dev = app_config.comp_dev;
		start_meth = app_config.start_meth;

		max_mm = ai_config.msg_mem;
		max_rl = ai_config.max_res;
		min_rl = ai_config.min_res;
		b_temp = ai_config.base_temp;
		prompt_p = ai_config.prompt_p;
		top_k = ai_config.top_k;
		top_p = ai_config.top_p;
		typical_p = ai_config.typical_p;
		rep_penalty = ai_config.rep_penalty;

		if (payload.skip_inputs) return;

		$('#user_name').val(human_name);
		$('#bot_name').val(bot_name);
		$('#voices').val(bot_voice);
		$('#speech_vol').val(speech_vol);
		$('#speech_rate').val(speech_rate);
		$('#speech_pitch').val(pitch_shift);

		$('#avatar_img').prop('src', 'file://'+avatar_img);
		$('#script_dir').val(script_dir);
		$('#python_bin').val(python_bin);
		$('#model_dir').val(model_dir);
		$('#sd_model').val(sd_model);
		$('#model_args').val(model_args);
		$('#mtype_select').val(model_type);
		$('#device_select').val(comp_dev);
		$('#startup_select').val(start_meth);

		$('#max_msg_mem').val(max_mm);
		$('#max_res_len').val(max_rl);
		$('#min_res_len').val(min_rl);
		$('#base_temp').val(b_temp);
		$('#pp_select').val(prompt_p);
		$('#top_k').val(top_k);
		$('#top_p').val(top_p);
		$('#typical_p').val(typical_p);
		$('#rep_penalty').val(rep_penalty);

		$('#gen_max_len').val(gen_config.max_len);
		$('#gen_min_len').val(gen_config.min_len);
		$('#gen_temp').val(gen_config.temp);
		$('#gen_top_k').val(gen_config.top_k);
		$('#gen_top_p').val(gen_config.top_p);
		$('#gen_typ_p').val(gen_config.typical_p);
		$('#gen_rep_p').val(gen_config.rep_penalty);
		
		$('#infer_steps').val(gen_config.inference_steps);
		$('#guidance').val(gen_config.guidance_scale);
		
		if (gen_config.image_width != 'auto' && gen_config.image_height != 'auto') {
			$('#img_width').val(gen_config.image_width);
			$('#img_height').val(gen_config.image_height);
			$('#is_input_box').show();
		}

		avatar_mp4 = 'file://'+script_dir+'/MakeItTalk/examples/face_pred_fls_speech_audio_embed.mp4';
		$('#tmode_img').prop('src', './img/talk_'+talk_mode+'.png');
	});
	
	function ApplySettings() {
		let sdir = TrimLast($('#script_dir').val().trim().replaceAll('\\', '/'), '/');
		let mdir = TrimLast($('#model_dir').val().trim().replaceAll('\\', '/'), '/');
		let sddir = TrimLast($('#sd_model').val().trim().replaceAll('\\', '/'), '/');
		let pbin = $('#python_bin').val().trim().replaceAll('\\', '/');
		let margs = $('#model_args').val().replaceAll('\\', '/');
		let mtype = $('#mtype_select').val();
		let cdev = $('#device_select').val();
		let smeth = $('#startup_select').val();
		if (script_dir != sdir || python_bin != pbin || model_dir != mdir || sd_model != sddir || model_args != margs || model_type != mtype || comp_dev != cdev || start_meth != smeth) {
			ipcRenderer.send('config-app', { script_dir: sdir, python_bin: pbin, model_dir: mdir, sd_model: sddir, model_args: margs, model_type: mtype, comp_dev: cdev, start_meth: smeth });
		}
	}
	
	function ApplyConfig() {
		if (adv_show) {
			const maxmm = $('#max_msg_mem').val();
			const maxrl = $('#max_res_len').val();
			const minrl = $('#min_res_len').val();
			const btemp = $('#base_temp').val();
			const topk = $('#top_k').val();
			const topp = $('#top_p').val();
			const typp = $('#typical_p').val();
			const repp = $('#rep_penalty').val();
			const promptp = $('#pp_select').find(':selected').val();
			if (max_mm != maxmm || max_rl != maxrl || min_rl != minrl || b_temp != btemp || 
			topk != top_k || topp != top_p || typp != typical_p || repp != rep_penalty || prompt_p != promptp) {
				ipcRenderer.send('config-ai', {
					max_mmem: maxmm, max_rlen: maxrl, min_rlen: minrl, temp: btemp, 
					tk: topk, tp: topp, typ: typp, rp: repp, pp: promptp
				});
				ipcRenderer.send('show-alert', { msg: 'New settings applied.' });
			}
		} else {
			const hname = $('#user_name').val();
			const bname = $('#bot_name').val();
			const spvol = $('#speech_vol').val();
			const srate = $('#speech_rate').val();
			const spitch = $('#speech_pitch').val();
			const newvc = $('#voices').find(':selected').val();
			let alert_msg = true;

			if (human_name != hname || bot_name != bname) {
				ipcRenderer.send('update-users', { human: hname, bot: bname });
				alert_msg = false;
			}
			
			if (bot_voice != newvc || speech_vol != spvol || speech_rate != srate || pitch_shift != spitch) {
				ipcRenderer.send('config-voice', { voice:newvc, vol:spvol, rate:srate, pitch:spitch });
				if (alert_msg) ipcRenderer.send('show-alert', { msg: 'New settings applied.' });
			}
		}
	}
	
	function ToggleConfig() {
		if (adv_show) {
			$('#adv_btn').html('AI SETTINGS');
			$('#adv_config').hide();
			$('#basic_config').show();
		} else {
			$('#adv_btn').html('MAIN SETTINGS');
			$('#basic_config').hide();
			$('#adv_config').show();
		}
		adv_show = !adv_show;
	}
	
	function ToggleEditPrompt() {
		if ($('#edit_dialog').is(":hidden")) {
			$('#edit_dialog').show();
			$('#prompt_txta').focus();
		} else {
			$('#edit_dialog').hide();
		}
	}
	
	function ApplyNewPrompt() {
		prompt = $('#prompt_txta').val();
		p_html = EncodeHTML(prompt).replaceAll("\n", "<br>");
		ipcRenderer.send('update-prompt', prompt.replaceAll("\n", "[AI_UI_BR]"));
		$('#init_prompt').html(p_html+' '+pedit_img_html);
		ToggleEditPrompt();
	}
	
	function ChangeTalkMode() {
		if (++talk_mode>2) talk_mode = 0;
		$('#tmode_img').prop('src', './img/talk_'+talk_mode+'.png');
		ipcRenderer.send('update-talk-mode', talk_mode);
	}
	
	function ChangeAvatar() {
		window.aiuiAPI.openAvatar().then(result => {
			if (result === false) return;
			$('#loading_box').show();
			avatar_img = result.replaceAll('\\', '/');
			ipcRenderer.send('update-avatar', avatar_img);
			$('#avatar_img').prop('src', 'file://'+avatar_img);
			$('#avatar_vid').hide();
			$('#avatar_img').show();
		});
	}
	
	function OpenFolder(elem) {
		window.aiuiAPI.openFolder().then(result => {
			if (result === false) return;
			$('#'+elem).val(result.replaceAll('\\', '/'));
		});
	}
	
	function OpenFile(elem) {
		window.aiuiAPI.openFile().then(result => {
			if (result === false) return;
			$('#'+elem).val(result.replaceAll('\\', '/'));
		});
	}
	
	function SetAppVersion() {
		window.aiuiAPI.getAppVersion().then(result => {
			$('#app-version').html(result);
			$('#aiui-version').html(result);
		});
	}
	
	function ShowInFolder(elem) {
		let file_path = script_dir+'/ai_images/';
		if (elem !== null) {
			file_path = $(elem).prop('src').
			replace('file:///', '').replace('file://', '');
		}
		ipcRenderer.send('show-in-dir', file_path);
	}
	
	function RestartScript() {
		ipcRenderer.invoke('restart-script');
	}
	
	function StartScript() {
		ipcRenderer.invoke('start-script');
	}
	
	function QuitApp() {
		ipcRenderer.invoke('close-app');
	}
	
	$(document).ready(function() {
		SetAppVersion();
		StartScript();

		$("#text_inp").on('keyup', function (e) {
			if (e.key === 'Enter' || e.keyCode === 13) {
				SendMsg();
			}
		});
		
		$("#gen_text_inp").on('keyup', function (e) {
			if (e.key === 'Enter' || e.keyCode === 13) {
				GenText();
			}
		});
		
		$("#img_text_inp").on('keyup', function (e) {
			if (e.key === 'Enter' || e.keyCode === 13) {
				GenImage();
			}
		});
		
		$("#img_text_neg").on('keyup', function (e) {
			if (e.key === 'Enter' || e.keyCode === 13) {
				GenImage();
			}
		});

		$('#area_inp').on('keydown', function(e) {
			if (e.key === 'Tab' || e.keyCode == 9) {
				e.preventDefault();
				let s = this.selectionStart;
				$(this).val(function(i, v) {
					return v.substring(0, s) + "\t" + v.substring(this.selectionEnd)
				});
				this.selectionEnd = s + 1;
			}
		});
		
		$('#avatar_img').on('load', function() {
			if ($(this).prop('naturalWidth') != 256 || $(this).prop('naturalHeight') != 256) {
				ipcRenderer.send('show-alert', { msg: 'Avatar image must have a width and height of 256x256' });
			}
		});
		
		$('#ip_select').on('change', function() {
			let ip_sel = $(this).find(':selected').val();
			switch (ip_sel) {
			case 'default':
				$('#prompt_txta').val(ip_vals.chat);
				break;
			case 'pygmalion':
				$('#prompt_txta').val(ip_vals.pygmalion);
				break;
			case 'bbcode':
				$('#prompt_txta').val(ip_vals.bbcode);
				break;
			}
		});
		
		$('#is_select').on('change', function() {
			let is_sel = $(this).find(':selected').val();
			switch (is_sel) {
			case 'auto':
				$('#is_input_box').hide();
				break;
			case 'custom':
				$('#is_input_box').show();
				break;
			}
		});
	});
	</script>
</head>
<body>
	<div id="container">

		<center id="loading_box" class="hidden"><div id="loading_msg">Processing avatar image... please wait.</div></center>

		<div id="main_menu">
			<button class="menu_btn menu_sel" onclick="ChatPage(this)">CHAT BOT</button><button class="menu_btn" onclick="TextPage(this)">TEXT GEN</button><button class="menu_btn" onclick="ImagePage(this)">IMAGE GEN</button><button class="menu_btn" onclick="ConsolePage(this)">CONSOLE</button><button class="menu_btn" onclick="ConfigPage(this)">SETTINGS</button><button class="menu_btn" onclick="AboutPage(this)">ABOUT</button>
			<span id="menu_txt">AI UI v<span id="app-version"></span></b>
		</div>
		
		<div id="content">

			<div id="chat_app">		
				<div id="chat_box">
					<div id="chat_log">
						<div class="prompt"><p id="init_prompt" class="prompt_txt">Initializing AI Engine... please wait.</p></div>
					</div>
					<div id="thinking"></div>
					<div id="exp_box"><textarea id="area_inp" class="txt_area hidden" name="msg_txta"></textarea></div>
					<div id="send_box">
						<div id="text_box">
							<input type="text" id="text_inp" name="msg_txt" placeholder="Type your message" autofocus>
						</div>
						<button id="exp_btn" onclick="ToggleMsgBox()"><img src="./img/expand.png" width="20" /></button>
						<div id="butt_box">
							<button id="send_btn" class="btn chat_btn" onclick="SendMsg()" disabled>SEND</button><button id="redo_btn" class="btn chat_btn" onclick="RedoLast()" disabled>REDO</button><button id="cont_btn" class="btn chat_btn" onclick="ContChat()" disabled>CONT</button><button id="clear_btn" class="btn chat_btn" onclick="ClearChat()" disabled>CLEAR</button>
						</div>
					</div>
					<div id="edit_dialog" class="text_dialog hidden">
						<div class="dialog_head">EDIT INITIAL PROMPT</div>
						<div class="dialog_body">
							<textarea id="prompt_txta" class="txt_area"></textarea>
						</div>
						<div class="dialog_foot">
							<label id="ips_label">Useful Prompts:</label>
							<select id="ip_select" class="cfg_drp">
								<option value="default" selected>Default</option>
								<option value="pygmalion">Pygmalion Format</option>
								<option value="bbcode">BBCode Instructions</option>
							</select>
							<button class="btn dialog_btn" onclick="ApplyNewPrompt()">APPLY</button>
							<button class="btn dialog_btn" onclick="ToggleEditPrompt()">CANCEL</button>
						</div>
					</div>
				</div>
				
				<div id="chat_side">
					<div id="avatar_box">
						<img id="avatar_img" width="256" height="256" src="" />
						<video id="avatar_vid" class="hidden" width="256" height="256">
							<source id="avatar_source" src="" type="video/mp4">
						</video>
						<video id="other_vid" class="hidden" width="256" height="256">
							<source id="other_source" src="" type="video/mp4">
						</video>
						<button id="tmode_btn" class="config_btn" onclick="ChangeTalkMode()" disabled><img id="tmode_img" width="42" height="42" src="./img/talk_0.png" /></button>
						<button id="avatar_btn" class="config_btn" onclick="ChangeAvatar()" disabled><img width="42" height="42" src="./img/folder_b.png" /></button>
					</div>
					<center id="config_box">
						<div id="basic_config">
							<span class="cfg_lbl">User Names</span>
							<input type="text" id="user_name" class="cfg_usr" placeholder="Human Name">
							<input type="text" id="bot_name" class="cfg_usr" placeholder="Bot Name">
							<span class="cfg_lbl">Bot Voice</span>
							<select id="voices" class="cfg_drp"></select>
							<span class="cfg_lbl">Speech Volume</span>
							<input type="range" id="speech_vol" class="cfg_sld" min="0.05" max="1.0" step="0.05" value="1.0">
							<span class="cfg_lbl">Speech Rate</span>
							<input type="range" id="speech_rate" class="cfg_sld" min="1" max="400" value="200">
							<span class="cfg_lbl">Speech Pitch</span>
							<input type="range" id="speech_pitch" class="cfg_sld" min="-11" max="10" value="0">
						</div>
						<div id="adv_config">
							<span class="cfg_lbl">Max Message Memory <img class="help_icon" width="16" height="16" title="The number of messages the AI will remember. Higher values allow the AI to have a longer memory but will also increase the response time." /></span>
							<input type="number" id="max_msg_mem" class="cfg_num" min="2" max="100" value="5">
							<span class="cfg_lbl">Max Response Length <img class="help_icon" width="16" height="16" title="The maximum number of tokens to generate in each response. A token is like a word but spaces and other symbols may be considered a token." /></span>
							<input type="number" id="max_res_len" class="cfg_num" min="1" max="1000" value="50">
							<span class="cfg_lbl">Min Response Length <img class="help_icon" width="16" height="16" title="The minimum number of tokens to generate in each response. A token is like a word but spaces and other symbols may be considered a token." /></span>
							<input type="number" id="min_res_len" class="cfg_num" min="1" max="999" value="1">
							<span class="cfg_lbl">Base Temperature <img class="help_icon" width="16" height="16" title="A higher temperature value means the text will be more random and less predictable. The engine may briefly increase this value if the AI produces poor responses." /></span>
							<input type="number" id="base_temp" class="cfg_num" min="0.01" max="1.0" step="0.01" value="0.8">
							<span class="cfg_lbl">Prompt Persistence <img class="help_icon" width="16" height="16" title="Controls whether the initial prompt will be limited to the message memory or permanently included at the start of the actual prompt which is fed to the AI." /></span>
							<select id="pp_select" class="cfg_drp">
								<option value="0" selected>Memory Limited</option>
								<option value="1">Permanent</option>
								<option value="2">No Prompt</option>
							</select>
							<span class="cfg_lbl">Top-K <img class="help_icon" width="16" height="16" title="Only samples from the most probable K vocabulary tokens. Set to 0 to disable Top-K sampling." /></span>
							<input type="number" id="top_k" class="cfg_num" min="0" max="1000" value="50">
							<span class="cfg_lbl">Top-p <img class="help_icon" width="16" height="16" title="Only the smallest set of most probable tokens with probabilities that add up to this value or higher are kept for generation." /></span>
							<input type="number" id="top_p" class="cfg_num" min="0.01" max="1.0" step="0.01" value="1.0">
							<span class="cfg_lbl">Typical-p <img class="help_icon" width="16" height="16" title="Only the smallest set of the most locally typical tokens with probabilities that add up to this value or higher are kept for generation." /></span>
							<input type="number" id="typical_p" class="cfg_num" min="0.01" max="1.0" step="0.01" value="1.0">
							<span class="cfg_lbl">Repetition Penalty <img class="help_icon" width="16" height="16" title="Higher values should reduce repetitions but can be buggy. Set to 1.0 for no repetition penalty." /></span>
							<input type="number" id="rep_penalty" class="cfg_num" min="1.0" max="2.0" step="0.01" value="1.0">
						</div>
						<button id="apply_btn" class="btn cfg_btn" onclick="ApplyConfig()" disabled>APPLY</button>
						<button id="adv_btn" class="btn cfg_btn" onclick="ToggleConfig()">AI SETTINGS</button>
					</center>
				</div>
			</div>

			<div id="txtgen_app" class="hidden">
				<div id="txtgen_box">
					<div id="gen_result"></div>
					<div class="generating"></div>
					<div id="gen_exp_box"><textarea id="gen_area_inp" class="txt_area hidden"></textarea></div>
					<div class="gen_input_box">
						<div id="gen_text_box">
							<input type="text" id="gen_text_inp" placeholder="Opening text">
						</div>
						<button id="gen_exp_btn" onclick="ToggleGenBox()"><img src="./img/expand.png" width="20" /></button>
						<div id="gen_butt_box">
							<button id="gen_btn" class="btn" onclick="GenText()" disabled>GENERATE</button>
						</div>
					</div>
				</div>
				
				<div id="txtgen_side">
					<center>
						<h4 class="cfg_title">GENERATION SETTINGS</h4>
						<span class="cfg_lbl">Max Length <img class="help_icon" width="16" height="16" title="The maximum number of tokens to generate. A token is like a word but spaces and other symbols may be considered a token." /></span>
						<input type="number" id="gen_max_len" class="cfg_num" min="1" max="10000" value="50">
						<span class="cfg_lbl">Min Length <img class="help_icon" width="16" height="16" title="The minimum number of tokens to generate. A token is like a word but spaces and other symbols may be considered a token." /></span>
						<input type="number" id="gen_min_len" class="cfg_num" min="1" max="999" value="1">
						<span class="cfg_lbl">Temperature <img class="help_icon" width="16" height="16" title="A higher temperature value means the text will be more random and less predictable." /></span>
						<input type="number" id="gen_temp" class="cfg_num" min="0.01" max="1.0" step="0.01" value="0.8">
						<h4 class="cfg_title">ADVANCED SETTINGS</h4>
						<span class="cfg_lbl">Top-K <img class="help_icon" width="16" height="16" title="Only samples from the most probable K vocabulary tokens. Set to 0 to disable Top-K sampling." /></span>
						<input type="number" id="gen_top_k" class="cfg_num" min="0" max="1000" value="50">
						<span class="cfg_lbl">Top-p <img class="help_icon" width="16" height="16" title="Only the smallest set of most probable tokens with probabilities that add up to this value or higher are kept for generation." /></span>
						<input type="number" id="gen_top_p" class="cfg_num" min="0.01" max="1.0" step="0.01" value="1.0">
						<span class="cfg_lbl">Typical-p <img class="help_icon" width="16" height="16" title="Only the smallest set of the most locally typical tokens with probabilities that add up to this value or higher are kept for generation." /></span>
						<input type="number" id="gen_typ_p" class="cfg_num" min="0.01" max="1.0" step="0.01" value="1.0">
						<span class="cfg_lbl">Repetition Penalty <img class="help_icon" width="16" height="16" title="Higher values should reduce repetitions but can be buggy. Set to 1.0 for no repetition penalty." /></span>
						<input type="number" id="gen_rep_p" class="cfg_num" min="1.0" max="2.0" step="0.01" value="1.0">
						
						<button id="copy_txt_btn" class="btn cfg_btn" onclick="CopyGenTxt()">COPY TO CLIPBOARD</button>
						<button id="read_txt_btn" class="btn cfg_btn" onclick="ReadGenTxt()" disabled>TEXT TO SPEECH</button>
					</center>
				</div>
			</div>

			<div id="imggen_app" class="hidden">
				<div id="imggen_box">
					<div id="img_result"></div>
					<div class="generating"></div>
					<div class="gen_input_box">
						<div id="img_text_box">
							<input type="text" id="img_text_inp" placeholder="Prompt text"><input type="text" id="img_text_neg" placeholder="Negative prompt (optional)">
						</div>
						<div id="img_butt_box">
							<button id="img_btn" class="btn" onclick="GenImage()" disabled>GENERATE</button>
						</div>
					</div>
				</div>
				
				<div id="imggen_side">
					<center>
						<h4 class="cfg_title">GENERATION SETTINGS</h4>
						<span class="cfg_lbl">Inference Steps <img class="help_icon" width="16" height="16" title="The number of denoising steps. More steps usually lead to higher quality images at the expense of slower image generation." /></span>
						<input type="number" id="infer_steps" class="cfg_num" min="1" max="100" value="50">
						<span class="cfg_lbl">Guidance Scale <img class="help_icon" width="16" height="16" title="A higher guidance scale encourages the AI to adhere to the prompt but can lead to lower image quality. Enabled by setting higher than 1." /></span>
						<input type="number" id="guidance" class="cfg_num" min="0.0" max="10.0" step="0.1" value="7.5">
						<span class="cfg_lbl">Image Size</span>
						<select id="is_select" class="cfg_drp">
							<option value="auto" selected>Auto</option>
							<option value="custom">Custom</option>
						</select>
						<div id="is_input_box" class="hidden">
							<span class="cfg_lbl">Image Width</span>
							<input type="number" id="img_width" class="cfg_num" min="2" max="10000" value="512">
							<span class="cfg_lbl">Image Height</span>
							<input type="number" id="img_height" class="cfg_num" min="2" max="10000" value="512">
						</div>
						<button id="copy_img_btn" class="btn cfg_btn" onclick="CopyGenImg()">COPY TO CLIPBOARD</button>
						<button id="open_dir_btn" class="btn cfg_btn" onclick="OpenImgDir()">OPEN IMAGE FOLDER</button>
					</center>
				</div>
			</div>

			<div id="console_tab" class="hidden">
				<div id="log_box">
					<pre class="console_log">Application started</pre>
				</div>
			</div>

			<div id="config_tab" class="hidden">
				<center id="settings">
					<h2>App Settings</h2><hr>
					<div id="settings_row">
						<div class="settings_col">
							<span class="cfg_lbl">Engine Folder <img class="help_icon" width="16" height="16" title="The directory containing the python scripts for the AI engine. Should contain a folder called MakeItTalk." /></span>
							<div class="browse_btn"></div> <input type="text" id="script_dir" class="cfg_txt" value=""> <button class="btn browse_btn" onclick="OpenFolder('script_dir')">BROWSE</button>
							<span class="cfg_lbl">Python Binary <img class="help_icon" width="16" height="16" title="The location of your python binary (on Windows it's a file called python.exe)" /></span>
							<div class="browse_btn"></div> <input type="text" id="python_bin" class="cfg_txt" value=""> <button class="btn browse_btn" onclick="OpenFile('python_bin')">BROWSE</button>
							<span class="cfg_lbl">SD Model ID/Folder <img class="help_icon" width="16" height="16" title="The model ID (e.g. dreamlike-art/dreamlike-photoreal-2.0) or directory containing the Stable Diffusion model (optional, allows image generation)" /></span>
							<div class="browse_btn"></div> <input type="text" id="sd_model" class="cfg_txt" value=""> <button class="btn browse_btn" onclick="OpenFolder('sd_model')">BROWSE</button>
							<span class="cfg_lbl">Model ID/Folder <img class="help_icon" width="16" height="16" title="The model ID (e.g. PygmalionAI/pygmalion-6b) or the directory containing the text generation model (usually has a pytorch_model.bin file in it)" /></span>
							<div class="browse_btn"></div> <input type="text" id="model_dir" class="cfg_txt" value=""> <button class="btn browse_btn" onclick="OpenFolder('model_dir')">BROWSE</button>
						</div>
						<div class="settings_col">
							<span class="cfg_lbl">Model Setup <img class="help_icon" width="16" height="16" title="Optional setup arguments. Example: model_adapter=C:/model/adapter, torch_dtype=float32, custom_model_code=true, sd_safety_check=false, reserve_vram_mb=3200" /></span>
							<input type="text" id="model_args" class="cfg_txt" value="" placeholder="Setup arguments (comma separated)">
							<span class="cfg_lbl">Model Type <img class="help_icon" width="16" height="16" title="The type of AI model in the model folder (should be a text generation model in the HuggingFace Transformers format)." /></span>
							<select id="mtype_select" class="cfg_drp">
								<option value="0" selected>Auto-detect</option>
								<option value="1">GPT-Neo</option>
								<option value="2">Llama/Alpaca</option>
								<option value="3">ChatGLM</option>
								<option value="4">Falcon</option>
							</select>
							<span class="cfg_lbl">Compute Device <img class="help_icon" width="16" height="16" title="If your GPU doesn't support CUDA or you don't have enough VRAM then select the CPU or Auto option. Auto will try to use all available compute devices." /></span>
							<select id="device_select" class="cfg_drp">
								<option value="auto" selected>Auto</option>
								<option value="cpu">CPU</option>
								<option value="cuda">GPU</option>
							</select>
							<span class="cfg_lbl">Startup Method <img class="help_icon" width="16" height="16" title="Choose which models should be loaded when the engine starts. Models not loaded at startup will be loaded automatically when required." /></span>
							<select id="startup_select" class="cfg_drp">
								<option value="text" selected>Load text model</option>
								<option value="image">Load image model</option>
								<option value="both">Load both models</option>
								<option value="none">No model loading</option>
							</select>
						</div>
					</div>
					<br><hr><br>
					<button id="settings_btn" class="btn cfg_btn" onclick="ApplySettings()">APPLY</button>
					<button id="restart_btn" class="btn cfg_btn" onclick="RestartScript()">RESTART AI ENGINE</button>
				</center>
			</div>

			<div id="about_tab" class="hidden">
				<center id="about_box">
					<h2>About AI UI</h2><hr>
					<p>AI UI is a user-friendly interface for interacting with AI.<br>An open source project created by <a href="https://bitfreak.info" target="_blank">Bitfreak Software</a>.</p>
					<p><b>BTC Donations:</b> 18MWPVJA9mFLPFT3zht5twuNQmZBDzHoWF<br>
					<b>ETH Donations:</b> 0x3cd1742c4AEB0e2e7D64530EB1393ff6E84b2e9F</p>
					<hr>
					<p><b>App Version:</b> <span id="aiui-version"></span><br>
					<b>Electron Version:</b> <span id="electron-version"></span><br>
					<b>Node.js Version:</b> <span id="node-version"></span><br>
					<b>Chrome Version:</b> <span id="chrome-version"></span></p>
				</center>
			</div>
		</div>
	</div>
</body>
</html>